<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>配置中心</title>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="/css/jsonformter.css">
    <link rel="stylesheet" href="/plugin/css/layui.css" />
    <style>
        htlm,
        body {
            margin: 0;
            padding: 0;
            background: #F0F0F0;
        }

        #err {
            font-size: 12px;
            color: #bb0000;
        }

        .nav {
            background: #393D49;
            height: 50px;
        }

        .logo {
            color: #fff;
            font-size: 24px;
            height: 50px;
            line-height: 50px;
            margin-left: 10px;
        }

        .top_menu {
            text-align: right;
        }

        .top_menu .layui-icon-set-sm {
            color: #fff;
            font-size: 20px;
        }

        .logout {
            height: 50px;
            line-height: 50px;
            margin-right: 5px;
            width: 50px;
            float: right;
            text-align: center;
        }

        .logout:hover {
            box-shadow: 0 0 6px 20px rgba(0, 0, 0, .2) inset;
        }

        .container {
            padding: 10px;
        }

        .project_tab {
            border-bottom-style: none;
        }

        .project_tab li {
            margin-right: 10px;
            background: #dfdfdf;
            padding: 0 0 0 15px;
        }

        .project_tab li.layui-this {
            background: #fff;
        }

        .project_tab li .layui-tab-close {
            float: right;
            color: #333;
        }
    </style>
</head>

<body>
    <div class="layui-fluid" style="padding:0">
        <div class="layui-row nav">
            <div class="layui-col-md3">
                <div class="logo">
                    Logo
                </div>
            </div>
            <div class="layui-col-md9 top_menu">
                <div class="logout">
                    <i class="layui-icon layui-icon-set-sm"></i>
                </div>
            </div>
        </div>
        <div class="container">
            <!--[预留多环境]-->
            <!--[多项目]-->
            <div class="layui-col-md9">
                <button class="layui-btn" id="btn_add">
                    <i class="layui-icon">&#xe608;</i> 添加
                </button>
                <div class="layui-tab layui-tab-brief" lay-allowClose="true" lay-filter="project">
                    <ul class="layui-tab-title project_tab"></ul>
                    <!-- <div class="layui-tab-content">
                    </div> -->
                </div>
            </div>
            <div id="main">
                <div id="box">
                    <p>
                        <textarea id="txt" rows="10" class="layui-textarea"></textarea>
                    </p>
                    <p>
                        <div id='container'></div>
                    </p>
                    <p>
                        <button class="layui-btn" id="save">
                            <i class="layui-icon">&#x1005;</i> 保存
                        </button>
                    </p>
                    <p id="err">

                    </p>
                </div>
            </div>
        </div>
    </div>
    <script src="/js/jsonformter.js"></script>
    <script src="/plugin/layui.js"></script>
    <script>
        layui.use(['layer', 'element'], function () {
            var element = layui.element;
            var projects = [];
            var curr_space = "";
            //加载所有项目
            $.get("/list", function (res) {
                projects = res.data;
                res.data.forEach((item, index) => {
                    element.tabAdd('project', {
                        title: item,
                        content: '', //支持传入html
                        id: 'tab_' + index,
                    });
                })
                //切换选择第一个行
                element.tabChange('project', 'tab_0');
            });

            //监听Tab切换
            element.on('tab(project)', function () {
                let index = this.getAttribute('lay-id').replace("tab_", "");
                let data = projects[index * 1];
                if (!data) return;
                curr_space = data;
                //TODO:
                $.get("/all/" + data, function (res) {
                    $("#err").text("");
                    $("#txt").val(res.data);
                    var options = {
                        dom: '#container' //对应容器的css选择器
                    };
                    var jf = new JsonFormater(options); //创建对象
                    jf.doFormat(res.data, function (msg) {
                        $("#err").text(msg);
                    }); //格式化json
                })
            });
            //删除监听 
            element.on('tabDelete(project)', function () {
                let index = $(this).parent().attr("lay-id").replace("tab_", "");
                let data = projects[index * 1];
                if (!data) return;
                $.ajax({
                    url: "/" + data,
                    type: "DELETE"
                });
            });

            //添加新项目
            $("#btn_add").click(function () {
                layer.prompt({
                    title: "请输入配置名"
                }, function (value, index, elem) {
                    element.tabAdd('project', {
                        title: value,
                        content: '', //支持传入html
                        id: 'tab_' + projects.length,
                    });
                    projects.push(value)
                    var txt = $("#txt").val();
                    $.post("/all/" + value, {
                        txt: txt
                    }, function (res) {
                        layer.msg("保存成功")
                    })
                    layer.close(index);
                });
            })
            //保存当前结果
            $("#save").click(function () {
                var txt = $("#txt").val();
                $.post("/all/" + curr_space, {
                    txt: txt
                }, function (res) {
                    layer.msg("保存成功")
                })
            });
        });
    </script>
</body>

</html>